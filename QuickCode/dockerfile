FROM node:20-alpine

WORKDIR /app

COPY package.json .

RUN npm install --legacy-peer-deps

COPY . .

EXPOSE 3000

# Accept build arguments for Next.js public env variables
ARG NEXT_PUBLIC_API_FRONTEND_PROBLEM
ARG NEXT_PUBLIC_API_OPEN_API
ARG NEXT_PUBLIC_API_WEBSOCKET_URL
ARG NEXT_PUBLIC_API_JWT_SECRET
ARG NEXT_PUBLIC_API_ADMIN_KEY

# Set them as environment variables for the build
ENV NEXT_PUBLIC_API_FRONTEND_PROBLEM=$NEXT_PUBLIC_API_FRONTEND_PROBLEM
ENV NEXT_PUBLIC_API_OPEN_API=$NEXT_PUBLIC_API_OPEN_API
ENV NEXT_PUBLIC_API_WEBSOCKET_URL=$NEXT_PUBLIC_API_WEBSOCKET_URL
ENV NEXT_PUBLIC_API_JWT_SECRET=$NEXT_PUBLIC_API_JWT_SECRET
ENV NEXT_PUBLIC_API_ADMIN_KEY=$NEXT_PUBLIC_API_ADMIN_KEY

# Set default environment variables (can be overridden)
ENV NODE_ENV=production
ENV PORT=3000

# Build and start
RUN npm run build
CMD ["npm", "start"]